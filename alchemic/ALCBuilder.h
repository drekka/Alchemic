//
//  ALCObjectBuilder.h
//  alchemic
//
//  Created by Derek Clarkson on 23/08/2015.
//  Copyright Â© 2015 Derek Clarkson. All rights reserved.
//

@import Foundation;
@import ObjectiveC;

#import "ALCAbstractResolvable.h"
#import "ALCValue.h"
#import "ALCInternalMacros.h"
#import "ALCBuilderType.h"

@protocol ALCBuilderStorage;
@class ALCMacroProcessor;
@class ALCValueSourceFactory;
@class ALCVariableDependency;

NS_ASSUME_NONNULL_BEGIN

/**
 Class which builds objects and manages all their inter-dependencies.

 @discussion This class uses a variety of strategy classes to enact the functionality it provides.
 */

@interface ALCBuilder : ALCAbstractResolvable<ALCValue>

#pragma mark - Properties

/**
 Set to YES if an AcRegister(...) macro is used.

 @discussion Allows the builder to configure based on whether an AcRegister(...) has been executed.
 */
@property (nonatomic, assign, getter=isRegistered) BOOL registered;

/**
 Override of value so it can be writable in builders.
 */
@property (nonatomic, strong) id value;

/// The name assocated with this builder. This is used when a ALCModelSearchExpression is generated by the `AcName(...)` macro.
@property (nonatomic, strong, readonly) NSString *name;

/// If the builder is to be regarded as a primary builder.
@property (nonatomic, assign, readonly) BOOL primary;

/**
 Returns YES if the builder is using an instance of ALCClassBuilderType. 
 @discussion In other words, if the builder is representing a class rather than a method or initializer.
 */
@property (nonatomic, assign, readonly, getter=isClassBuilder) BOOL classBuilder;

/**
 Returns a set of ALCVariableDependencies.
 
 @discussion These variable dependencies can then be used to inject values into a class. Normally only a class builder can do this.
 */
@property (nonatomic, strong, readonly) NSSet<ALCVariableDependency *> *variableInjections;

/**
 The macro processor which will be used by the builder to process macro arguments.

 @discussion The builder will create this object internally so that it is configured correctly for the builders requirements in terms of what macros it will accept.
 */
@property (nonatomic, strong, readonly) ALCMacroProcessor *macroProcessor;

#pragma mark - Initializers

hideInitializer(init);

/**
 default initializer.

 @param builderType An instance of ALCBuilderType which provides the functility which defines what type of builder this is.

 @return An instance of a ALCBuilder.

 */

-(instancetype) initWithBuilderType:(id<ALCBuilderType>) builderType NS_DESIGNATED_INITIALIZER;

#pragma mark - Tasks

/**
 Adds a variable injection to the builder. 
 
 @discussion This is used on class builders to add variables within the class that will be injected.

 @param variable           The variable to be injected.
 @param valueSourceFactory An ALCValueSourceFactory instance that defines where to get the value for the variable from.
 */
-(void) addVariableInjection:(Ivar) variable
          valueSourceFactory:(ALCValueSourceFactory *) valueSourceFactory;

/**
 Call to directory access the builder using a custom set of values.

 @param arguments An NSarray of the values matching the methods arguments.

 @return The return object from the method with all dependencies injected.
 */
-(id) invokeWithArgs:(NSArray<id> *) arguments;

/**
 This must be called after the builders macroProcessor has been populated with macros.

 @discussion It's job is to finish the configuartion of the builder based on what the macroProcessor has been passed.
 */
-(void) configure;

/**
 Injects an object passed to the builder.

 @param object The object which needs dependencies injected.
 */
-(void)injectDependencies:(id) object;

@end

NS_ASSUME_NONNULL_END